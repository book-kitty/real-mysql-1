# 데이터 암호화
> MySQL 5.7 버전부터 지원한 데이터 암호화는 데이퍼 파일에 대해서만 암호화가 가능했지만  
> MySQL 8.0 버전부터는 리두로그나 언두로그, 바이너리 로그 등도  모두 암호화 기능을 지원하기 시작했다.


## MySQL 서버의 데이터 암호화
MySQL 서버의 암호화 기능은 데이터베이스 서버와 디스크 사이의 데이터를 읽고 쓰는 지점에서 암호화 또는 복호화를 수행한다.  
즉 InnoDB 스토리지 엔진의 I/O 레이어에서만 데이터 암호화 및 복호화가 실행되는 것이다. 때문에 애플리케이션 개발자는 데이터를 읽을 때 이미 복호화가 된 데이터를 읽게 된다.  
데이터 암호화 기능이 활성화 되어있더라도 사용자 입장에서는 아무런 차이가 없기 때문에 이러한 암호화 방식을 `TDE(Transparent Data Encryption)`이라고 한다.

### 2단계 키 관리
> MySQL 서버의 TDE에서 암호화 키는 키링 플러그인에 의해 관리된다. MySQL 서버의 키링 플러그인은 2단계(2-Tier) 키 관리 방식을 사용한다.

**마스터 키 & 테이블스페이스 키**
- MySQL 서버의 데이터 암호화는 `마스터 키`와 `테이블스페이스  키`라는 두 가지 종류의 키를 가지고 있다.
- 마스터 키는 외부에 공개되고 테이블스페이스 키는 외부에 노출되지 않는다. 
- 마스터 키는 외부에 노출되기 때문에 자주 변경하는 것이 좋다.
- 테이블스페이스 키는 외부에 노출되지 않기 때문에 변경할 일이 거의 없다. 
- 마스터 키를 변경하면 변경된 마스터키로 테이블스페이스 키를 다시 암호화 하여 저장한다.

**2단계 키를 사용한 암호화 방식**
- 마스터 키를 이용해 테이블 스페이스 키를 암호화하고 각 테이블의 데이터파일 헤더에 저장한다.
- 데이터는 테이블 스페이스키를 이용하여 암호화 한다. 
- 테이블 스페이스 키가 변경되면 MySQL 서버는 데이터 파일의 모든 데이터를 다시 복호화 했다가 암호화 해야한다. 
- 마스터 키를 변경되는 동안 MySQL 서버의 테이블스페이스 키 자체와 데이터 파일의 데이터는 전혀 변경되지 않는다. 

**2단계 키 관리를 사용하는 이유는?**
```tesx
마스터 키에 비해 테이블스페이스 키는 자주 변경되지 않는다. 외부에 노출되는 키와 내부의 키를 따로 두지 않았다면  
특정 주기마다 키를 변경했을 때 매번 모든 데이터 파일을 복호화하고 암호화 하는 과정이 자주 발생하게 될 것이다.  
이는 많은 CPU 작업을 요구하기에 성능 저하로 이어질 수 있다. MySQL은 이를 보완하기 위해 2단계 키 관리를 사용하는 것이다.
```

**MySQL에서 지원하는 암호화 알고리즘**
- TDE에서 지원하는 암호화 알고리즘은 AES 256비트이다. 이외의 알고리즘은 지원하지 않는다.
- 테이블스페이스 키는 AES-256 ECB 알고리즘을 이용해 암호화 한다. 
- 실제 데이터 파일은 AES-256 CBC 알고리즘을 이용해 함호화 한다.
 
### 암호화와 성능
> MySQL 서버의 암호화는 TDE 방식이기 때문에 디스크로부터 한 번 읽은 데이터 페이지는 복호화되어 InnoDB 버퍼풀에 적재된다.  
> 그래서 데이터 페이지가 한번 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다. 하지만 버퍼풀에 존재하지 않는  
> 데이터 페이지를 읽을 경우에는 복호화 과정을 거쳐야하기 때문에 복호화 시간동안 쿼리 처리가 지연될 것이다. 디스크에 저장할 때도  
> 암호화 하는 과정이 추가로 필요하여 시간이 오래 걸리지만, 데이터를 암호화 할 때는 MySQL 서버의 백그라운드 스레드가 수행되기 때문에  
> 실제 사용자 쿼리가 지연되는 것은 아니다. 
- AES 암호화 알고리즘은 암호화하고자 하는 데이터의 평문 길이가 짧은 경우 암호화된 결과의 용량이 더 커질 수도 있다.
- 그러나 이미 데이터 페이지의 크기가 암호화 키보다 훨신 크기 때문에 암호화된 결과는 대부분 평문의 결과와 동일한 크기를 가진다.
- 즉 암호화 한다고 해서 InnoDB 버퍼 풀의 효율이 달라지거나 메모리 사용 효율이 떨어지는 현상은 발생하지 않는다.
- 데이터 압축과 암호화를 둘 다 사용할 경우 압축이 먼저 이루어지고 암호화를 수행한다.
  - 암호화된 결과문은 아주 랜덤한 바이트 배열을 가지게 되는데 이는 압축률을 상당히 떨어트린다.
  - 암호화가 먼저 실행되고 압축이 적용된다면 MySQL 서버는 InnoDB 버퍼풀에 존재하는 데이터 페이지에 대해서도 암복호화 작업을 수행해야 된다. 
  
### 응용 프로그램 암호화와 비교
> 응용 프로그램에서 암호화를 사용하면, 암호화된 칼럼은 인덱스를 생성하더라도 인덱스를 100% 활용할 수 없다. 그리고 암호화 되어 저장된 컬럼은 범위로 조회하는 것이 어려울 수 있다.  
> 하지만 MySQL 서버의 암호화를 이용하면 사용자가 바라보는 데이터는 이미 복호화 되어있기 때문에 문제가 되지 않는다. 특별한 이유가 없다면 MySQL 서버의 암호화 방식을 권장한다.


### 언두 로그 및 리두 로그 암호화
- MySQL 서버는 리두 로그나 언두 로그를 평문으로 저장하다가 암호화가 활성화 되면 그때부터 생성되는 데이터들을 암호화 하여 저장한다.
- 암호화를 사용하다가 암호화를 해제하면 마찬가지로 기존에 저장해두었던 데이터는 암호화된 상태로 두고 이후 저장된 데이터를 평문으로 저장한다.
  - 그래서 상황에 따라 며칠 또는 몇 달 동안 여전히 암호화 키가 필요할 수 있다.
- 리두 로그와 언두 로그를 암호화 할 때도 테이블스페이스 키가 사용되는데, 여기서 말하는 테이블스페이스 키는 테이블의 키가 아니라 리두 로그와 언두 로그 파일을 위한 프라이빗 키이다. 