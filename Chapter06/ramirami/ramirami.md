# 데이터 압축

## MySQL 데이터 압축
> MySQL 서버에서 디스크에 저장된 데이터 파일의 크기는 쿼리 성능 & 백업 복구 시간과 밀접하게 연관이 있다.  
> 데이터 파일의 크기가 클 수록 성능은 떨어지게 되는데, MySQL은 이를 보완하기 위해 데이터 압축 기능을 제공한다.


### 1. 페이지 압축 (Transparent Page Compression)
- MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지를 압축하는 것을 페이지 압축이라고 한다.
- 적어도 하나의 테이블은 동일한 크기의 페이지로 통일되어야 한다.
    - 이를 지키기 위해 페이지 압축은 펀치 홀이라는 기능을 사용한다.
    - 펀치홀은 특정 버전의 파일 시스템에서만 지원된다.
- OS뿐만 아니라 하드웨어에서도 펀치홀 기능을 제공해야 하기 때문에 제약이 크다.

**페이지 압축 과정**
1. 16KB 페이지를 압축 (압축 결과를 7KB로 가정)
2. MysQL 서버는 디스크에 압축된 결과 7KB를 기록
    - 이때 MySQL 서버는 압축 데이터 7KB에 9KB의 빈 데이터를 기록
3. 디스크에 데이터를 기록한 후, 7KB 이후의 공간 9KB에 대해 펀치 홀을 생성
4. 파일 시스템은 7KB만 남기고 나머지 디스크의 9KB 공간은 다시 운영체제로 반납

### 2. 테이블 압축
- 테이블 압축은 OS나 하드웨어에 대한 제약없이 사용할 수 있기 때문에 활용도가 페이지 압축보다 높다.
- 테이블 압축을 사용하려면 별도의 테이블 스페이스를 사용해야 한다.
- 페이지 크기가 32KB, 64KB인 경우 테이블 압축을 사용할 수 없다.
- 테이블 압축을 사용하려면 테이블을 생성할 때 `ROW_FORMET=COMPRESSED` 옵션을 명시해야 한다.
- 압축된 페이지의 목표 크기는 `KEY_BLOCK_SIZE`로 지정한다. 값은 2n으로만 설정할 수 있다.
    - innoDB 스토리지 엔진의 페이지 크기가 16KB라면 4KB, 8KB로만 생성할 수 있다.
- 테이블 데이터가 매우 빈번하게 조회되고 변경된다면 압축은 고려하지 않는 것이 좋다. 


**테이블 압축 적용 과정 (KEY_BLOCK_SIZE = 8KB)**
1. 16KB의 데이터 페이지를 압축
    - 압축된 결과가 8KB 이하이면 그대로 디스크에 저장한다. (압축완료)
    - 압축된 결과가 8KB를 초과하면 원본 페이지를 스플릿해서 2개의 페이지에 8KB씩 저장한다.
- 나뉜 페이지 각각에 대해 "1"번 단계를 반복 실행

**KEY_BLOCK_SIZE 설정**
- `KEY_BLOCK_SIZE` 크기를 너무 작게 설정할 경우 원본 페이지를 스플릿하는 현상이 자주 발생할 수 있다.
- 일반적으로 압축 실패율을 3~5% 미만으로 유지할 수 있게 KEY_BLOCK_SIZE를 선택하는 것이 좋다.
  - 데이터 페이지를 스플릿할 경우 압축 실패로 판단한다.

**테이블 압축의 단점**
1. 버퍼 풀 공간 활용률이 낮음
2. 쿼리 처리 성능이 낮음
3. 빈번한 데이터 변경 시 압축률이 떨어짐


### 3. 압축된 페이지의 버퍼 풀 적재 및 사용
- innoDB 스토리지 엔진은 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리한다.
- 압축된 상태를 그대로 관리하는 `LRU 리스트`와 압축된 페이지들의 압축 해제 버전인 `Unzip LRU 리스트`를 별도로 관리하게 된다.
- 결국 압축을 사용할 경우 LRU 리스트는 압축된 페이지와 압축되지 않은 페이지를 모두 갖게되는 것이다.

**압축을 이용했을 떄 버퍼 풀 공간 확보 전략**  
> 결국 압축을 사용할 경우 버퍼 풀의 공간을 이중으로 사용하게 된다. innoDB는 버퍼 풀의 공간을 효율적으로 사용하기 위해 아래와 같은 전략을 취한다.  

- innoDB 버퍼 풀의 공간이 필요한 경우에는 LRU 리스트에서 압축된 데이터 페이지는 유지하고 압축 해제된 버전은 제거하여 공간을 확보한다.
- 압축된 데이터 페이지가 자주 사용되는 경우에는 Unzip_LRU 리스트에 압축 해제된 페이지를 계속 유지하면서 압축 및 압축 해제 작업을 최소화 한다.
- 압축된 데이터 페이지가 사용되지 않아서 LRU 리스트에서 제거되는 경우에는 Unzip_LRU 리스트에서 함께 제거된다.  

**압축 해제된 버전의 데이터를 적절한 수준으로 유지하는 방법**
- CPU 사용량이 높은 서버에서는 가능하면 압축과 압축 해제를 피하기 위해 Unzip_LRU의 비율을 높여서 유지한다.
  - ?? 압축 해제는 피할 수 있다는 생각이 드는데, 잦은 압축은 어떻게 피하는지 잘 모르겠음 .. 
- Disk IO 사용량이 높은 서버에서는 가능하면 Unzip_LRU 리스트의 비율을 낮춰서 innoDB 버퍼풀의 공간을 더 확보한다. 
  - 버퍼 풀의 공간을 확보하여 더 많은 데이터 파일을 캐시해두므로 Disk IO를 최소화 할 수 있을 것 같다.


